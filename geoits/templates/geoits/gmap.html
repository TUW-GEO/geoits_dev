{% extends "base.html" %}
{% load staticfiles %}
{% block head_title %}GeoITS Development{% endblock %}

{% block map %}

<script language="Javascript" type="text/javascript" src="http://ajax.googleapis.com/ajax/libs/jquery/1.11.3/jquery.min.js"></script>
<script type="text/javascript" src="http://maps.googleapis.com/maps/api/js?v=3.exp&sensor=false&libraries=drawing,geometry"></script>
<script src="{% static 'js/gmap.js' %}"></script>

<body style="height: 50px;">
    <!--Google Maps APIv3 Background-->
    <div action="" method="POST"> {%csrf_token%}
        <div id="map_canvas"></div>
    </div>
    <div id="result"></div>

    <nav class="cbp-spmenu cbp-spmenu-vertical cbp-spmenu-left" id="cbp-spmenu-s1">
        <button class="fa fa-times" style="float: right; margin: 5px" id="hideSlide"></button>
        <h3>Issue</h3>

        <div style="margin: 0px 20px 15px">
          <a href="" id="hist">
            <i class="fa fa-history fa-2x" type="button"></i>
          </a>
        </div>

        <div class="form-group" style="margin: 5px">

            <textarea class="form-control" id="title" style="height: 35px;" placeholder="Title"></textarea>

            <div id="editor" class="form-control">
                <textarea v-model="input" debounce="300" id="raw" placeholder="Raw"></textarea>
                <div v-html="input | marked"></div>
            </div>

            <input class="btn btn-primary" id="submit" type="button" value="Submit" name="csrfmiddlewaretoken"></input>

            <textarea id="poly_id" style="display: none"></textarea>

        </div>
    </nav>
    <div class="navbar-form navbar-right" style="display: none" id="button">
        <button class="btn btn-success" id="showLeft">Save</button>
    </div>

    <!-- Permission for Mark an Issue -->
    {% if user.is_authenticated %}
    <input id="draw_poly" type="button" class="btn btn-danger btn-lg" style="position: relative; right: 10px; width: 220px; height: 45px;"></input>

    {% else %}
    <button id="draw_poly" style="visibility: hidden;"></button>

    <button class="btn btn-danger btn-lg" style="position: relative; left: 50%" data-toggle="modal" data-target="#myModal">Mark an Issue</button>
    <!-- Modal -->
    <div id="myModal" class="modal fade" role="dialog">
      <div class="modal-dialog">

        <!-- Modal content-->
        <div class="modal-content">
          <div class="modal-header">
            <button type="button" class="close" data-dismiss="modal">&times;</button>
              <p>Please Sign In or Register to mark an issue</p>
          </div>
          <div class="modal-body">
            <p>
              <input id="signin" type="button" class="btn btn-success" value="Sign In"/>
              or
              <input id="register" type="button" class="btn btn-success" value="Register"/>
            </p>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
          </div>
        </div>

      </div>
    </div>
    {% endif %}

    <script>
        var menuLeft = document.getElementById( 'cbp-spmenu-s1' ),
            showLeft = document.getElementById( 'showLeft' ),
            body = document.body;
        showLeft.onclick = function() {
            classie.toggle( menuLeft, 'cbp-spmenu-open' );
         };
            hideLeft = document.getElementById( 'hideSlide' ),
        hideLeft.onclick = function() {
            classie.toggle( this, 'active' );
            classie.toggle( menuLeft, 'cbp-spmenu-open' );
         };
    </script>
    <script>
        $("#hideSlide").click(function() {
            geoField.setMap(null);
            ShowDrawingTools(true);
            drawingControlDiv.style.display = '';
        })
    </script>
    <script>
     $("#signin").click(function() {
        window.location.href="/accounts/login/"
     })

     $("#register").click(function() {
        window.location.href="/accounts/signup/"
     })
    </script>
    <script>
     $(document).ready(function() {
         var currentPolygon;
         new Vue({
             el: '#editor',
             data: {
                 input: ''
             },
             filters: {
                 marked: marked
             }
         })
         var polyArray = [];
         $("#submit").click(function() {
            var w_title = $('#title').val();
            var w_raw = $('#raw').val();
            var w_poly_id = $('#poly_id').val();
             $.ajax({
                 url: "test/",
                 type: 'POST',
                 cache: false,
                 dataType: 'json',
                 data: {
                     geom: wkt,
                     title: w_title,
                     raw: w_raw,
                     message: '',
                     markup: "Markdown",
                     polygon_id: w_poly_id,
                     csrfmiddlewaretoken: $("input[name='csrfmiddlewaretoken']").val()
                 },
                 error: function(jqXHR, textStatus, errorThrown) {
                     alert("Messaging failed: " + errorThrown);
                 },
                 success: function(data) {
                     if(!data.success){
                         window.location.href="/accounts/login/"
                     }
                 }
             });
         });
         initialize();
         $.ajax({
             url: "load_polygons/",
             dataType: 'json',
             type: 'GET',
             success: function(data, status, jqXHR){
                 $.each(data, function(i, polygon){
                     var coords = [];
                     $.each(polygon.geom, function(i,points){
                         $.each(points, function(i, point){
                             coords.push({lat: point[1], lng: point[0]})
                         })
                     })
                    var poly = new google.maps.Polygon({
                        paths: coords,
                        strokeColor: '#FF0000',
                        strokeOpacity: 0.8,
                        strokeWeight: 2,
                        fillColor: '#FF0000',
                        fillOpacity: 0.35
                    });

                     var polygonStore = [];
                     polygonStore['id'] = polygon.id;
                     polygonStore['obj'] = poly;
                     poly.indexID = polygon.id;
                     poly.selected = false;
                     polyArray.push(polygonStore);
                     google.maps.event.addListener(poly, 'click', function (event) {
                         if(currentPolygon){
                             currentPolygon.setOptions({strokeColor: "#FF0000"});
                         }
                         currentPolygon = this;
                         this.setOptions({strokeColor: "#000000"});
                         console.log(this.indexID);
                         var id = this.indexID;
                          $.ajax({
                              url: "get_wiki/?id=" + id,
                              dataType: 'json',
                              type: 'GET',
                              success: function(data, status, jqXHR){
                                    $("#title").val(data.title);
                                    $("#raw").val(data.raw);
                                    $("#raw").trigger("change");
                                    $("#poly_id").val(id);
                                    var link = "/wiki/" + id + "/history/";
                                    var a = document.getElementById('hist');
                                    a.href = link;
                              }
                         });
                         var menuLeft = document.getElementById( 'cbp-spmenu-s1' );
                         if(!$('#cbp-spmenu-s1').hasClass('cbp-spmenu-open')){
                             classie.toggle( menuLeft, 'cbp-spmenu-open' );
                         }
                     });
                     poly.setMap(map);
                 })
             }
         });
     });
    </script>
</body>

{% endblock %}
